// nextflow.config

// ====================================================================================
//                            PIPELINE PARAMETERS
// ====================================================================================
// 


params {
    // --- Input and Output ---
    input              = '/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/test_sample.tsv'
    outdir             = '/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/results'
    ref_genome_fasta   = '/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/reference/Homo_sapiens_assembly38.fasta'
    // --- Core Software Paths (REQUIRED) ---
    wdl_script         = '/home/lt692/project_pi_njl27/lt692/human_mito_calling-main/MitochondriaPipeline_multisample.wdl' // <-- REQUIRED
    cromwell_jar       = '/home/lt692/project_pi_njl27/lt692/cromwell-90.jar'                       // <-- REQUIRED
}

// ====================================================================================
//                      CROMWELL & WDL INPUT PARAMETERS
// ====================================================================================

// These parameters control how Cromwell submits its own jobs to Slurm.
params.cromwell_options = [
    queue: '',
    runtime_minutes: 1440,
    cpus: 8,
    memory: 32768
]
cromwell_submit_rate_limit = 180

// --- Static inputs for the WDL workflow ---
// All paths required by your WDL script, except for the sample list, should be defined here.
// Please replace the placeholder paths with the actual paths on your system.
params.wdl_inputs = [
    picard: "/home/lt692/project_pi_njl27/lt692/picard.jar",
    haplocheckCLI: "/home/lt692/project_pi_njl27/lt692/haplocheckCLI-master/haplocheckCLI.jar",
    gatk: "/home/lt692/project_pi_njl27/lt692/gatk-4.6.2.0/gatk-package-4.6.2.0-local.jar",
    compress_output_vcf: true,
    ref_fasta: params.ref_genome_fasta,
    ref_dict: params.ref_genome_fasta.replaceAll('.fasta\$|.fa\$', '.dict'),
    ref_fasta_index: params.ref_genome_fasta + '.fai',
    mt_dict: "/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/wdl_input_files/Homo_sapiens_assembly38.chrM.dict",
    mt_fasta: "/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/wdl_input_files/Homo_sapiens_assembly38.chrM.fasta",
    mt_fasta_index: "/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/wdl_input_files/Homo_sapiens_assembly38.chrM.fasta.fai",
    mt_amb: "/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/wdl_input_files/Homo_sapiens_assembly38.chrM.fasta.amb",
    mt_ann: "/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/wdl_input_files/Homo_sapiens_assembly38.chrM.fasta.ann",
    mt_bwt: "/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/wdl_input_files/Homo_sapiens_assembly38.chrM.fasta.bwt",
    mt_pac: "/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/wdl_input_files/Homo_sapiens_assembly38.chrM.fasta.pac",
    mt_sa: "/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/wdl_input_files/Homo_sapiens_assembly38.chrM.fasta.sa",
    mt_shifted_dict: "/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/wdl_input_files/Homo_sapiens_assembly38.chrM.shifted_by_8000_bases.dict",
    mt_shifted_fasta: "/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/wdl_input_files/Homo_sapiens_assembly38.chrM.shifted_by_8000_bases.fasta",
    mt_shifted_fasta_index: "/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/wdl_input_files/Homo_sapiens_assembly38.chrM.shifted_by_8000_bases.fasta.fai",
    mt_shifted_amb: "/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/wdl_input_files/Homo_sapiens_assembly38.chrM.shifted_by_8000_bases.fasta.amb",
    mt_shifted_ann: "/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/wdl_input_files/Homo_sapiens_assembly38.chrM.shifted_by_8000_bases.fasta.ann",
    mt_shifted_bwt: "/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/wdl_input_files/Homo_sapiens_assembly38.chrM.shifted_by_8000_bases.fasta.bwt",
    mt_shifted_pac: "/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/wdl_input_files/Homo_sapiens_assembly38.chrM.shifted_by_8000_bases.fasta.pac",
    mt_shifted_sa: "/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/wdl_input_files/Homo_sapiens_assembly38.chrM.shifted_by_8000_bases.fasta.sa",
    shift_back_chain: "/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/wdl_input_files/ShiftBack.chain",
    blacklisted_sites: "/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/wdl_input_files/blacklist_sites.hg38.chrM.bed",
    blacklisted_sites_index: "/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/wdl_input_files/blacklist_sites.hg38.chrM.bed.idx",
    non_control_region_interval_list: "/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/wdl_input_files/non_control_region.interval_list",
    control_region_shifted_reference_interval_list: "/home/lt692/scratch_pi_njl27/lt692/human_mt_variant_calling/wdl_input_files/control_region_shifted.interval_list"
]

params.hail_pipeline_config = [

        num_workers: 1,

        // --- Input directories (will be created by the Nextflow process) ---
        // These are relative to the process work directory
        raw_vcf_dir: "wdl_outputs/vcfs",
        haplocheck_dir: "wdl_outputs/contamination",
        wgs_metrics_dir: "wdl_outputs/wgs_metrics",
        mt_coverage_dir: "wdl_outputs/coverage",
        
        // --- VEP cache directory ---
        vep_cache_dir: "~/scratch_pi_njl27/lt692/human_mt_variant_calling/annotation_databases", // As specified in the script

        // --- Output directories (will be created by the Nextflow process) ---
        vep_vcf_dir: "hail_results/annotation_individual/vep_vcf/",
        metadata_dir: "hail_results/annotation_individual/metadata/",
        final_output_dir: "hail_results/annotation_individual/final_outputs/",

        // --- Input metadata files (please update these paths) ---
        master_pedigree_file: "/home/lt692/palmer_scratch/vcf_annotation/combine_metadata_test.txt",
        
        // --- Annotation Database Paths (please update these paths) ---
        gnomadcache: "/home/lt692/scratch_pi_njl27/lt692/annotation_databases/gnomad.genomes.v3.1.sites.chrM.reduced_annotations.tsv",
        clinvarcache: "/home/lt692/scratch_pi_njl27/lt692/annotation_databases/clinvar_chrMT_02122024.txt",
        mitomap_polycache: "/home/lt692/scratch_pi_njl27/lt692/annotation_databases/MITOMAP_polymorphisms_02122024.txt",
        mitomap_diseasecache: "/home/lt692/scratch_pi_njl27/lt692/annotation_databases/MITOMAP_disease_02122024.txt",
        helixcache: "/home/lt692/scratch_pi_njl27/lt692/annotation_databases/HelixMTdb_20200327.tsv",
        haplogroup_varcache: "/home/lt692/scratch_pi_njl27/lt692/annotation_databases/rCRS-centered_vars_with_haplo_final_update.txt",
        mitimpactcache: "/home/lt692/scratch_pi_njl27/lt692/annotation_databases/MitImpact_db_3.1.2.txt",
        mitotipcache: "/home/lt692/scratch_pi_njl27/lt692/annotation_databases/mitotip_scores.txt",
        hmtvarcache: "/home/lt692/scratch_pi_njl27/lt692/annotation_databases/hmtvar_annotations.txt"
    ]

// ====================================================================================
//                            EXECUTION PROFILES
// ====================================================================================

conda.enabled = true

profiles {
    standard {
        process.executor = 'local'
    }

    cluster {
        process {
            executor = 'slurm'
            conda = '/home/lt692/.conda/envs/bio_pipeline_env'
        }
        // Tell the native WDL engine to use Slurm as its backend
        cromwell.backend = 'Slurm'
    }
}

// ====================================================================================
//                       EXECUTOR & PROCESS CONFIGURATION
// ====================================================================================

// This block controls the job submission rate to avoid overwhelming the scheduler
executor {
    name = 'slurm'
    queueSize = 20
    submitRateLimit = '180/h'
}

// Global settings for all processes
process {
    errorStrategy = 'retry'
    maxRetries = 2

    // Specific resource configurations for heavy processes
    withName: 'DOWNLOAD_FASTQ' { 
        cpus = 8
        memory = '8.GB'
        time = '12h'
    }
    withName: 'ALIGN_AND_UNSORT' { 
        cpus = 16
        memory = '18.GB'
        time = '12h'
    }
    withName: 'SORT_AND_CONVERT_TO_CRAM' { 
        cpus = 16
        memory = '18.GB'
        time = '12h'
    }
    withName: 'MERGE_CRAMS' { 
        cpus = 16
        memory = '18.GB'
        time = '12h'
    }
    withName: 'GENERATE_CRAM_TSV' { 
        cpus = 2
        memory = '8.GB'
        time = '12h'
    }
    withName: 'GENERATE_WDL_JSON' { 
        cpus = 2
        memory = '8.GB'
        time = '12h'
    }
    withName: 'RUN_WDL_VARIANT_CALLING' { 
        cpus = 4
        memory = '8.GB'
        time = '12h'
    }
}

// Enable DSL2, the modern Nextflow syntax
nextflow.enable.dsl=2